# 部署说明

## 前提说明

该部署脚本提供在3台机器上单独部署每一个节点，更符合真实使用场景，这3台机器需要有内网IP，并且3台机器需要网络能通

## 部署步骤

1. 安装docker和docker-compose（在3台机器上都执行）

```shell

# 下载docker和docker-compose安装包
wget https://primihub.oss-cn-beijing.aliyuncs.com/dev/docker20.10.tar.gz

# 解压
tar zxf docker20.10.tar.gz

# 安装
cd docker20.10
bash install_docker.sh

# 验证
docker version
docker-compose version

# 有如下输出则安装正常
# docker version
Client:
 Version:           20.10.10
···
# docker-compose version
Docker Compose version v2.6.0
```

2. 加载docker镜像 （在三台机器上都执行）

```shell
# 下载镜像包
wget https://primihub.oss-cn-beijing.aliyuncs.com/dev/docker-images-3.0.tar.gz

# 解压
tar zxf docker-images.tar.gz

# 加载镜像
cd docker-images
for i in ./*.tar.gz ; do docker load -i $i; done

# 验证 
docker images 
```

3. 部署平台 
```shell
# 下载安装包 （在三台机器上都执行）
wget https://primihub.oss-cn-beijing.aliyuncs.com/dev/docker-one-in-one-3.0.tar.gz

# 解压 
tar xf docker-one-in-one.tar.gz

在第一台机器上，执行
cd docker-one-in-one/node0
bash deploy.sh

在第二台机器上，执行
cd docker-one-in-one/node1
bash deploy.sh 第一台机器的IP (将第一台机器的IP以参数的形式传递进去)

（node之间的资源发现使用第一台机器上的redis，所以需要配置第一台机器的IP为redis地址）

在第三台机器上，执行
cd docker-one-in-one/node2
bash deploy.sh 第一台机器的IP
```

### 查看部署结果
```
第一台机器上
# docker-compose ps -a
NAME                COMMAND                  SERVICE             STATUS              PORTS
application         "/bin/sh -c 'java -j…"   application         running             
fusion              "/bin/sh -c 'java -j…"   fusion              running             0.0.0.0:8080->8080/tcp, :::8080->8080/tcp
gateway             "/bin/sh -c 'java -j…"   gateway             running             
mysql               "docker-entrypoint.s…"   mysql               running             0.0.0.0:3306->3306/tcp, :::3306->3306/tcp, 33060/tcp
nacos-server        "bin/docker-startup.…"   nacos               running             0.0.0.0:8848->8848/tcp, :::8848->8848/tcp
node                "/bin/bash -c './pri…"   node                running             
rabbitmq            "docker-entrypoint.s…"   rabbitmq            running             4369/tcp, 5671-5672/tcp, 15671-15672/tcp, 25672/tcp
redis               "docker-entrypoint.s…"   redis               running             0.0.0.0:6379->6379/tcp, :::6379->6379/tcp
weiyan-web          "/docker-entrypoint.…"   nginx               running             0.0.0.0:30080->80/tcp, :::30080->80/tcp

第二台机器上
# docker-compose ps -a
NAME                COMMAND                  SERVICE             STATUS              PORTS
application         "/bin/sh -c 'java -j…"   application         running             
gateway             "/bin/sh -c 'java -j…"   gateway             running             
mysql               "docker-entrypoint.s…"   mysql               running             0.0.0.0:3306->3306/tcp, :::3306->3306/tcp
nacos-server        "bin/docker-startup.…"   nacos               running             0.0.0.0:8848->8848/tcp, :::8848->8848/tcp
node                "/bin/bash -c './pri…"   node                running             
rabbitmq            "docker-entrypoint.s…"   rabbitmq            running             25672/tcp
redis               "docker-entrypoint.s…"   redis               running             6379/tcp
weiyan-web          "/docker-entrypoint.…"   nginx               running             0.0.0.0:30080->80/tcp, :::30080->80/tcp


第三台机器上
# docker-compose ps -a
NAME                COMMAND                  SERVICE             STATUS              PORTS
application         "/bin/sh -c 'java -j…"   application         running             
gateway             "/bin/sh -c 'java -j…"   gateway             running             
mysql               "docker-entrypoint.s…"   mysql               running             0.0.0.0:3306->3306/tcp, :::3306->3306/tcp
nacos-server        "bin/docker-startup.…"   nacos               running             0.0.0.0:8848->8848/tcp, :::8848->8848/tcp
node                "/bin/bash -c './pri…"   node                running             
rabbitmq            "docker-entrypoint.s…"   rabbitmq            running             25672/tcp
redis               "docker-entrypoint.s…"   redis               running             6379/tcp
weiyan-web          "/docker-entrypoint.…"   nginx               running             0.0.0.0:30080->80/tcp, :::30080->80/tcp
```

### 访问页面

3台机器都启动完成后，在浏览器分别访问

http://第一台机器(node0)的IP:30080

http://第二台机器(node1)的IP:30080

http://第三台机器(node2)的IP:30080

默认用户密码都是 admin / 123456

第一次登录后需要新建机构和加入群组，具体操作步骤请看 新建机构和设置中心节点说明文档。


### 停止服务

```shell
docker-compose down
```